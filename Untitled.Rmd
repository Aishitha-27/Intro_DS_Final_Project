---
title: "Understanding Sales patterns and return dynamics in E-Commerce"
author: Team 3
output: html_document
date: "2024-11-13"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r basic_libraries, include=FALSE}
library(ezids)
library(ggplot2)
library(dplyr)
library(leaflet)
library(tidyverse)
library(outliers)
```


#Glimpse of a dataset
```{r}
data=read.csv("online_sales_dataset.csv")
head(data, 5)
```
## Structure and Summary of Dataset

```{r}
str(data)
```


```{r}
xkablesummary(data, title = "Summary of Dataset")
```
Looking for missing values
```{r}
colSums(is.na(data))
```

```{r}
data_clean<- na.omit(data)
```


```{r}
colSums(is.na(data_clean))
```


```{r}
dim(data_clean)
```

Applying random sample of 10,000 rows for our project
```{r}
set.seed(123) 
data_reduced <- data_clean %>% sample_n(10000)
```

```{r}
nrow(data_reduced)
```

```{r}
dim(data_reduced)
```
```{r}

# Boxplot for Quantity to visualize outliers

ggplot(data_reduced, aes(x = "", y = Quantity)) +
    geom_boxplot(fill = "lightblue", color = "darkblue") +
    labs(title = "Boxplot of Quantity", y = "Quantity") +
    theme_minimal()

# Boxplot for UnitPrice to visualize outliers

ggplot(data_reduced, aes(x = "", y = UnitPrice)) +
    geom_boxplot(ofill = "lightblue", color = "darkblue") +
    labs(title = "Boxplot of UnitPrice", y = "Unit Price") +
    theme_minimal()

# Boxplot for Discount to visualize outliers

ggplot(data_reduced, aes(x = "", y = Discount)) +
    geom_boxplot(fill = "lightblue", color = "darkblue") +
    labs(title = "Boxplot of Discount", y = "Discount") +
    theme_minimal()
```


```{r}
kd2_outliers <- function(column) {
  density <- density(column, na.rm = TRUE)
  threshold <- 0.01  # Define a threshold for low-density regions
  outlier_indices <- which(density(column)$y < threshold)
  return(length(outlier_indices))  # Return the count of outliers
}

outliers_quantity <- kd2_outliers(data_reduced$Quantity)
outliers_unit_price <- kd2_outliers(data_reduced$UnitPrice)
outliers_discount <- kd2_outliers(data_reduced$Discount)

cat("Outliers in Quantity:", outliers_quantity, "\n")
cat("Outliers in Unit Price:", outliers_unit_price, "\n")
cat("Outliers in Discount:", outliers_discount, "\n")
```

```{r}
remove_kd2_outliers <- function(df, column) {
  density <- density(df[[column]], na.rm = TRUE)
  threshold <- 0.01  # Define a threshold for low-density regions
  outlier_indices <- which(density$y < threshold)
  if (length(outlier_indices) > 0) {
    df <- df[-outlier_indices, ]
  }
  return(df)
}

cleaned_data <- data_reduced %>%
  remove_kd2_outliers("Quantity") %>%
  remove_kd2_outliers("UnitPrice") %>%
  remove_kd2_outliers("Discount")
```

```{r}
str(cleaned_data)
```
```{r}
library(dplyr)
```
```{r}
library(ggplot2)
```
```{r}
# Check column names of cleaned_data
names(cleaned_data)

```
```{r}
# Summarize total sales by country
sales_by_country <- cleaned_data %>%
  group_by(Country) %>%
  summarise(Sales = sum(Sales, na.rm = TRUE))
```
```{r}
#VISUALIZATION
# Total Sales by Country
sales_by_country <- cleaned_data %>%
  group_by(Country) %>%
  summarise(TotalSales = sum(Sales, na.rm = TRUE))

ggplot(sales_by_country, aes(x = reorder(Country, TotalSales), y = TotalSales)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  coord_flip() +
  labs(
    title = "Total Sales by Country",
    x = "Country",
    y = "Total Sales"
  ) +
  theme_minimal()
```
```{r}
# Proportion of Return Statuses
return_status_counts <- cleaned_data %>%
  group_by(ReturnStatus) %>%
  summarise(Count = n()) %>%
  mutate(Percentage = (Count / sum(Count)) * 100)  # Calculate the percentage

# Plot with percentages
ggplot(return_status_counts, aes(x = "", y = Count, fill = ReturnStatus)) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar("y", start = 0) +
  geom_text(aes(label = paste0(round(Percentage, 1), "%")), position = position_stack(vjust = 0.5)) +  # Add percentage labels
  labs(
    title = "Proportion of Return Statuses",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(legend.title = element_blank())
```

```{r}
str(cleaned_data)
```
```{r}
library(dplyr)
library(ggplot2)
```
```{r}
# Summarize total sales by product description
top_products <- cleaned_data %>%
  group_by(Description) %>%  # Use 'Description' as it matches your dataset
  summarise(TotalSales = sum(Sales, na.rm = TRUE)) %>%  # Sum of 'Sales'
  arrange(desc(TotalSales)) %>%  # Arrange by descending total sales
  slice(1:10)  # Select the top 10 products

# Plotting top 10 products by total sales
ggplot(top_products, aes(x = reorder(Description, TotalSales), y = TotalSales)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  coord_flip() +  # Flip coordinates for better readability
  labs(
    title = "Top 10 Products by Total Sales",
    x = "Product Description",
    y = "Total Sales"
  ) +
  theme_minimal()

```
```{r}
install.packages("tidyr")  # Install if not already installed
library(tidyr)             # Load the package
```
```{r}
library(reshape2)  
```
```{r}
names(cleaned_data)
```
```{r}
library(lubridate)
```
```{r}
cleaned_data <- cleaned_data %>%
  mutate(InvoiceDate = as.POSIXct(InvoiceDate, format = "%Y-%m-%d %H:%M"))

# Create YearMonth column
cleaned_data <- cleaned_data %>%
  mutate(YearMonth = format(InvoiceDate, "%Y-%m"))

# Stacked Sales by Category Over Time
category_sales <- cleaned_data %>%
  group_by(YearMonth, Category) %>%
  summarise(TotalSales = sum(Sales, na.rm = TRUE), .groups = "drop")

ggplot(category_sales, aes(x = YearMonth, y = TotalSales, fill = Category)) +
  geom_bar(stat = "identity", position = "stack") +
  labs(
    title = "Stacked Sales by Category Over Time",
    x = "Time (Year-Month)",
    y = "Total Sales",
    fill = "Category"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
```{r}
# Total Sales by Payment Method
sales_by_payment <- cleaned_data %>%
  group_by(PaymentMethod) %>%
  summarise(TotalSales = sum(Sales, na.rm = TRUE))

ggplot(sales_by_payment, aes(x = reorder(PaymentMethod, TotalSales), y = TotalSales)) +
  geom_bar(stat = "identity", fill = "darkgreen") +
  coord_flip() +
  labs(
    title = "Total Sales by Payment Method",
    x = "Payment Method",
    y = "Total Sales"
  ) +
  theme_minimal()
```
```{r}
# Pie chart of top-selling products
top_products_pie <- top_products %>%
  ggplot(aes(x = "", y = TotalSales, fill = Description)) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar("y", start = 0) +
  labs(
    title = "Top 10 Products by Total Sales",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(legend.title = element_blank())
# Display the plot
top_products_pie

```


```{r}
# Sales Distribution by Order Priority
sales_by_priority <- cleaned_data %>%
  group_by(OrderPriority) %>%
  summarise(TotalSales = sum(Sales, na.rm = TRUE))

ggplot(sales_by_priority, aes(x = reorder(OrderPriority, TotalSales), y = TotalSales)) +
  geom_bar(stat = "identity", fill = "orange") +
  coord_flip() +
  labs(
    title = "Sales Distribution by Order Priority",
    x = "Order Priority",
    y = "Total Sales"
  ) +
  theme_minimal()
```

```{r}
# Top 10 countries by total sales
top_countries <- sales_by_country %>%
  arrange(desc(TotalSales)) %>%
  slice(1:10)

ggplot(top_countries, aes(x = reorder(Country, TotalSales), y = TotalSales)) +
  geom_bar(stat = "identity", fill = "lightcoral") +
  coord_flip() +
  labs(
    title = "Top 10 Countries by Total Sales",
    x = "Country",
    y = "Total Sales"
  ) +
  theme_minimal()


```
```{r}
# Total Sales by Category and Return Status
sales_by_category_return <- cleaned_data %>%
  group_by(Category, ReturnStatus) %>%
  summarise(TotalSales = sum(Sales, na.rm = TRUE))

ggplot(sales_by_category_return, aes(x = Category, y = TotalSales, fill = ReturnStatus)) +
  geom_bar(stat = "identity", position = "stack") +
  labs(
    title = "Total Sales by Category and Return Status",
    x = "Category",
    y = "Total Sales",
    fill = "Return Status"
  ) +
  theme_minimal()
```



